# Increment 1.3: Development Server & CLI

## Overview
This increment focuses on improving developer productivity with a comprehensive development server and CLI tools. The development server includes hot reload, request logging, and enhanced error reporting, while the CLI provides project scaffolding and development utilities.

## Objectives
- Implement development server with hot reload
- Add request logging and debugging features
- Create CLI tools for project generation
- Provide development-specific error reporting
- Enable file watching and automatic restart

## API Design

### Development Server Configuration
```typescript
import { createRouter, createServer } from 'bunserve'

const router = createRouter()

// Development server with enhanced features
const server = createServer({
  router,
  port: 3000,
  development: {
    enabled: true,
    hotReload: true,
    cors: true,
    logging: {
      enabled: true,
      level: 'debug', // 'debug' | 'info' | 'warn' | 'error'
      includeHeaders: false,
      includeBody: false
    },
    errorHandling: {
      stackTraces: true,
      errorDetails: true
    },
    static: {
      enabled: true,
      path: './public',
      index: 'index.html'
    }
  }
})

// Hot reload support
if (process.env.NODE_ENV === 'development') {
  console.log('üî• Development mode with hot reload enabled')
}
```

### Enhanced Request Logging
```typescript
// Development server with detailed logging
const server = createServer({
  router,
  development: {
    enabled: true,
    logging: {
      enabled: true,
      format: 'dev', // 'dev' | 'json' | 'combined'
      level: 'debug',
      colors: true,
      timestamp: true
    }
  }
})

// Console output example:
// [DEBUG] 2024-01-15 10:30:45 GET /api/users 200 12ms
// [INFO]  2024-01-15 10:30:46 POST /api/users 201 45ms
// [ERROR] 2024-01-15 10:30:47 GET /api/error 500 2ms

// Custom logging middleware
router.use(({ request }, next) => {
  const start = Date.now()
  const context = Context.get<{ requestId: string }>()
  
  console.log(`[${context.requestId}] ‚Üí ${request.method} ${request.url}`)
  
  const result = next()
  
  const duration = Date.now() - start
  console.log(`[${context.requestId}] ‚Üê ${request.method} ${request.url} (${duration}ms)`)
  
  return result
})
```

### Hot Module Replacement (HMR)
```typescript
// HMR-enabled development server
const server = createServer({
  router,
  development: {
    enabled: true,
    hotReload: {
      enabled: true,
      paths: ['./src/**/*.ts', './routes/**/*.ts'],
      ignore: ['node_modules/**', '*.test.ts'],
      debounce: 100
    }
  }
})

// HMR event handlers
if (import.meta.hot) {
  import.meta.hot.on('bunserve:reload', () => {
    console.log('üîÑ Hot reload triggered')
    // Clear require cache for changed files
    Object.keys(require.cache).forEach(key => {
      if (key.includes('/src/') || key.includes('/routes/')) {
        delete require.cache[key]
      }
    })
  })
}
```

### Development Error Handling
```typescript
// Development-specific error middleware
if (process.env.NODE_ENV === 'development') {
  router.use(async ({}, next) => {
    try {
      return await next()
    } catch (error) {
      const context = Context.get<{ requestId: string }>()
      
      console.error(`[${context.requestId}] Development Error:`)
      console.error('  Message:', error.message)
      console.error('  Stack:', error.stack)
      console.error('  Type:', error.constructor.name)
      
      return {
        error: error.message,
        stack: error.stack,
        type: error.constructor.name,
        requestId: context.requestId,
        timestamp: new Date().toISOString()
      }
    }
  })
}

// Development error page
router.get('/dev-error', ({ set }) => {
  set.status = 500
  set.content = 'html'
  
  return `
    <!DOCTYPE html>
    <html>
      <head>
        <title>Development Error</title>
        <style>
          body { font-family: 'Monaco', 'Menlo', monospace; padding: 20px; background: #1a1a1a; color: #fff; }
          .error-container { background: #2d2d2d; border-radius: 8px; padding: 20px; margin: 20px 0; }
          .stack-trace { background: #1e1e1e; padding: 15px; border-radius: 4px; overflow-x: auto; }
          .stack-line { margin: 2px 0; color: #ccc; }
          .highlight { color: #569cd6; }
          .error-message { color: #f48771; font-size: 18px; margin-bottom: 10px; }
        </style>
      </head>
      <body>
        <h1>üêõ Development Error</h1>
        <div class="error-container">
          <div class="error-message">${error.message}</div>
          <div class="stack-trace">
            ${error.stack.split('\n').map(line => 
              `<div class="stack-line">${line.replace(/^/g, '&nbsp;&nbsp;')}</div>`
            ).join('')}
          </div>
        </div>
      </body>
    </html>
  `
})
```

## CLI Tools

### Project Scaffolding
```bash
# Create new project
bunx bunserve create my-api

# Output:
# ‚úÖ Created project: my-api
# üìÅ my-api/
#   üìÑ package.json
#   üìÑ tsconfig.json
#   üìÑ src/index.ts
#   üìÑ src/routes/users.ts
#   üìÑ src/middleware/auth.ts
#   üìÑ README.md
#   üìÑ .gitignore
#
# üöÄ Next steps:
#   cd my-api
#   bun install
#   bun run dev
```

### Development Server CLI
```bash
# Start development server
bunx bunserve dev

# With custom port
bunx bunserve dev --port 3001

# With custom config
bunx bunserve dev --config bunserve.config.ts

# Hot reload mode
bunx bunserve dev --hot

# Verbose logging
bunx bunserve dev --verbose
```

### Route Generation CLI
```bash
# Generate route boilerplate
bunx bunserve generate route users

# Generate route with CRUD operations
bunx bunserve generate route posts --crud

# Generate route with middleware
bunx bunserve generate route admin --middleware auth,admin

# Generate TypeScript interfaces
bunx bunserve generate route users --typescript
```

### Configuration Management
```typescript
// bunserve.config.ts
import { defineConfig } from 'bunserve'

export default defineConfig({
  server: {
    port: 3000,
    host: 'localhost'
  },
  development: {
    enabled: true,
    hotReload: true,
    logging: {
      enabled: true,
      level: 'debug'
    }
  },
  routes: {
    directory: './src/routes',
    autoImport: true
  },
  middleware: {
    directory: './src/middleware',
    autoImport: true
  }
})
```

## Implementation Details

### Development Server Class
```typescript
interface DevelopmentOptions {
  enabled?: boolean
  hotReload?: boolean | HotReloadOptions
  logging?: LoggingOptions
  errorHandling?: ErrorHandlingOptions
  static?: StaticOptions
  cors?: boolean | CorsOptions
}

interface HotReloadOptions {
  enabled?: boolean
  paths?: string[]
  ignore?: string[]
  debounce?: number
}

interface LoggingOptions {
  enabled?: boolean
  format?: 'dev' | 'json' | 'combined'
  level?: 'debug' | 'info' | 'warn' | 'error'
  colors?: boolean
  timestamp?: boolean
  includeHeaders?: boolean
  includeBody?: boolean
}

class DevelopmentServer {
  private options: DevelopmentOptions
  private fileWatcher?: FSWatcher
  private reloadCallbacks: Set<() => void> = new Set()
  
  constructor(private router: Router, options: DevelopmentOptions = {}) {
    this.options = {
      enabled: process.env.NODE_ENV === 'development',
      ...options
    }
    
    if (this.options.enabled) {
      this.setupDevelopmentFeatures()
    }
  }
  
  private setupDevelopmentFeatures(): void {
    this.setupLogging()
    this.setupHotReload()
    this.setupErrorHandling()
    this.setupStaticServing()
    this.setupCors()
  }
  
  private setupHotReload(): void {
    if (!this.options.hotReload) return
    
    const options = typeof this.options.hotReload === 'boolean' 
      ? { enabled: true }
      : this.options.hotReload
    
    if (!options.enabled) return
    
    // File watching with Bun
    this.fileWatcher = Bun.fs.watch({
      path: options.paths || ['./**/*.ts'],
      ignore: options.ignore || ['node_modules/**', '*.test.ts'],
      debounce: options.debounce || 100
    })
    
    this.fileWatcher.on('change', (event, filename) => {
      console.log(`üîÑ File changed: ${filename}`)
      this.triggerReload()
    })
  }
  
  private setupLogging(): void {
    if (!this.options.logging?.enabled) return
    
    const logger = new DevelopmentLogger(this.options.logging)
    
    this.router.use(async ({ request }, next) => {
      const start = Date.now()
      const context = Context.get()
      
      logger.logRequest(request, context)
      
      try {
        const result = await next()
        const duration = Date.now() - start
        logger.logResponse(request, result, duration)
        
        return result
      } catch (error) {
        const duration = Date.now() - start
        logger.logError(request, error, duration)
        throw error
      }
    })
  }
  
  private triggerReload(): void {
    this.reloadCallbacks.forEach(callback => callback())
    
    // Clear module cache for TypeScript files
    Object.keys(require.cache).forEach(key => {
      if (key.endsWith('.ts') && !key.includes('node_modules')) {
        delete require.cache[key]
      }
    })
    
    console.log('üîÑ Hot reload complete')
  }
  
  onReload(callback: () => void): void {
    this.reloadCallbacks.add(callback)
  }
}
```

### CLI Implementation
```typescript
// CLI entry point
#!/usr/bin/env node

import { Command } from 'commander'
import { createProject } from './commands/create'
import { startDevServer } from './commands/dev'
import { generateRoute } from './commands/generate'

const program = new Command()

program
  .name('bunserve')
  .description('BunServe CLI - Express-like routing for Bun')
  .version('1.0.0')

// Create project
program
  .command('create <project-name>')
  .description('Create a new BunServe project')
  .option('--typescript', 'Generate TypeScript project')
  .option('--git', 'Initialize git repository')
  .action((projectName, options) => {
    createProject(projectName, options)
  })

// Development server
program
  .command('dev')
  .description('Start development server')
  .option('-p, --port <port>', 'Port number', '3000')
  .option('--host <host>', 'Host address', 'localhost')
  .option('--config <path>', 'Configuration file path')
  .option('--hot', 'Enable hot reload')
  .option('--verbose', 'Verbose logging')
  .action((options) => {
    startDevServer(options)
  })

// Generate route
program
  .command('generate route <name>')
  .description('Generate route boilerplate')
  .option('--crud', 'Generate CRUD operations')
  .option('--middleware <list>', 'Comma-separated middleware list')
  .option('--typescript', 'Generate TypeScript interfaces')
  .action((name, options) => {
    generateRoute(name, options)
  })

program.parse()
```

### Route Generator
```typescript
// Route generation logic
export async function generateRoute(name: string, options: GenerateRouteOptions) {
  const templatePath = options.crud ? 'templates/route-crud.ts' : 'templates/route-simple.ts'
  const outputPath = `./src/routes/${name}.ts`
  
  const template = await Bun.file(templatePath).text()
  const content = template
    .replace(/{{NAME}}/g, name)
    .replace(/{{NAME_CAMEL}}/g, toCamelCase(name))
    .replace(/{{NAME_PASCAL}}/g, toPascalCase(name))
  
  if (options.middleware) {
    const middlewareList = options.middleware.split(',')
    const middlewareImports = middlewareList.map(m => `import ${m} from '../middleware/${m}'`).join('\n')
    const middlewareArray = `[${middlewareList.join(', ')}]`
    
    content = content
      .replace('// {{MIDDLEWARE_IMPORTS}}', middlewareImports)
      .replace('// {{MIDDLEWARE_ARRAY}}', middlewareArray)
  }
  
  await Bun.write(outputPath, content)
  console.log(`‚úÖ Generated route: ${outputPath}`)
}
```

## Testing Strategy

### Development Server Tests
```typescript
describe('Development Server', () => {
  test('enables development features', () => {
    const router = createRouter()
    router.get('/test', () => 'test')
    
    const server = createServer({
      router,
      development: { enabled: true }
    })
    
    expect(server.options.development.enabled).toBe(true)
  })
  
  test('handles hot reload events', async () => {
    const router = createRouter()
    const server = createServer({
      router,
      development: { hotReload: { enabled: true } }
    })
    
    let reloadTriggered = false
    server.onReload(() => {
      reloadTriggered = true
    })
    
    // Simulate file change
    server.triggerReload()
    
    expect(reloadTriggered).toBe(true)
  })
})
```

### CLI Tests
```typescript
describe('CLI Commands', () => {
  test('creates new project', async () => {
    const tempDir = mkdtempSync(path.join(os.tmpdir(), 'bunserve-test-'))
    
    await createProject('test-api', { 
      directory: tempDir,
      typescript: true 
    })
    
    expect(fs.existsSync(path.join(tempDir, 'package.json'))).toBe(true)
    expect(fs.existsSync(path.join(tempDir, 'src/index.ts'))).toBe(true)
    
    rimrafSync(tempDir)
  })
  
  test('generates route with CRUD', async () => {
    const tempDir = mkdtempSync(path.join(os.tmpdir(), 'bunserve-test-'))
    
    await generateRoute('users', {
      crud: true,
      directory: tempDir
    })
    
    const routeFile = path.join(tempDir, 'users.ts')
    expect(fs.existsSync(routeFile)).toBe(true)
    
    const content = fs.readFileSync(routeFile, 'utf8')
    expect(content).toContain('GET /users')
    expect(content).toContain('POST /users')
    expect(content).toContain('PUT /users/:id')
    expect(content).toContain('DELETE /users/:id')
    
    rimrafSync(tempDir)
  })
})
```

## Performance Considerations

### Development Server Optimization
- Efficient file watching with debouncing
- Minimal overhead for disabled features
- Fast module cache clearing
- Optimized logging format

### CLI Performance
- Fast project scaffolding
- Efficient template rendering
- Minimal dependency loading
- Quick file generation

## Documentation

### CLI Reference
- `bunserve create` - Project creation
- `bunserve dev` - Development server
- `bunserve generate route` - Route generation
- Configuration options

### Development Guide
- Setting up development environment
- Hot reload configuration
- Debugging techniques
- Development workflow

## Success Criteria

### Functional Requirements
- [ ] Development server with hot reload
- [ ] Request logging and debugging
- [ ] CLI project scaffolding
- [ ] Route generation tools
- [ ] Development error reporting
- [ ] Configuration file support

### Performance Requirements
- [ ] <100ms hot reload time
- [ ] <1s project creation time
- [ ] Minimal development overhead
- [ ] Fast file watching

### Developer Experience
- [ ] Intuitive CLI commands
- [ ] Clear error messages
- [ ] Helpful logging output
- [ ] Easy configuration

## Next Steps

This increment enhances developer productivity. The next increment (1.4) will focus on common middleware and helpers to provide essential functionality out of the box.